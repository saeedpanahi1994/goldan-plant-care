<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†ØªÛŒØ¬Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª - Ú¯Ù„â€ŒØ¯Ø§Ù†</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Vazirmatn', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #f0fdf4 0%, #f8fafc 40%, #ffffff 100%);
      padding: 20px;
      direction: rtl;
    }

    .card {
      background: white;
      border-radius: 24px;
      padding: 40px 28px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.08);
      text-align: center;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* Loading State */
    .loading-spinner {
      width: 56px;
      height: 56px;
      border: 4px solid rgba(76,175,80,0.15);
      border-top-color: #4CAF50;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: #4CAF50;
    }

    .loading-subtext {
      font-size: 13px;
      color: #9e9e9e;
      margin-top: 8px;
    }

    /* Result Icon */
    .icon-wrapper {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      animation: bounceIn 0.6s ease;
    }

    .icon-wrapper.success { background: #e8f5e9; }
    .icon-wrapper.failed { background: #ffebee; }

    .icon-wrapper svg {
      width: 44px;
      height: 44px;
    }

    .icon-wrapper.success svg { color: #4CAF50; }
    .icon-wrapper.failed svg { color: #F44336; }

    /* Title */
    .title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .title.success { color: #2e7d32; }
    .title.failed { color: #c62828; }

    /* Message */
    .message {
      font-size: 14px;
      color: #616161;
      line-height: 2;
      margin-bottom: 24px;
    }

    /* Info Box */
    .info-box {
      background: #f8fdf8;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 24px;
      border: 1px solid rgba(76,175,80,0.1);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-row:last-child { border-bottom: none; }

    .info-label {
      font-size: 13px;
      color: #9e9e9e;
      font-weight: 500;
    }

    .info-value {
      font-size: 14px;
      color: #212121;
      font-weight: 700;
      direction: ltr;
    }

    /* Buttons */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 14px;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      color: white;
      box-shadow: 0 4px 16px rgba(76,175,80,0.3);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #616161;
    }

    .btn-retry {
      background: linear-gradient(135deg, #FF9800, #FFB74D);
      color: white;
      box-shadow: 0 4px 16px rgba(255,152,0,0.3);
    }

    /* Logo */
    .logo {
      margin-top: 20px;
      font-size: 13px;
      color: #bdbdbd;
    }

    .logo span { font-size: 18px; }

    /* Hidden */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="card">

    <!-- Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
    <div id="state-loading">
      <div class="loading-spinner"></div>
      <p class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª...</p>
      <p class="loading-subtext">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
    </div>

    <!-- Ø­Ø§Ù„Øª Ù†ØªÛŒØ¬Ù‡ -->
    <div id="state-result" class="hidden">
      <div id="result-icon" class="icon-wrapper"></div>
      <h1 id="result-title" class="title"></h1>
      <p id="result-message" class="message"></p>
      
      <div id="result-info" class="info-box hidden"></div>

      <div id="result-buttons"></div>

      <div class="logo">
        <span>ğŸŒ±</span> Ú¯Ù„â€ŒØ¯Ø§Ù†
      </div>
    </div>

  </div>

  <script>
    // SVG Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§
    var ICON_SUCCESS = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
    var ICON_FAILED = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';

    var API_URL = 'http://130.185.76.46:4380/api';  // relative URL - proxied through Vercel rewrite to backend

    // Ø®ÙˆØ§Ù†Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ URL
    var params = new URLSearchParams(window.location.search);
    var authority = params.get('Authority');
    var status = params.get('Status');

    function showResult(success, title, message, refId, cardPan) {
      document.getElementById('state-loading').classList.add('hidden');
      document.getElementById('state-result').classList.remove('hidden');

      // Ø¢ÛŒÚ©ÙˆÙ†
      var iconEl = document.getElementById('result-icon');
      iconEl.className = 'icon-wrapper ' + (success ? 'success' : 'failed');
      iconEl.innerHTML = success ? ICON_SUCCESS : ICON_FAILED;

      // Ø¹Ù†ÙˆØ§Ù†
      var titleEl = document.getElementById('result-title');
      titleEl.className = 'title ' + (success ? 'success' : 'failed');
      titleEl.textContent = title;

      // Ù¾ÛŒØ§Ù…
      document.getElementById('result-message').textContent = message;

      // Ø§Ø·Ù„Ø§Ø¹Ø§Øª
      var infoEl = document.getElementById('result-info');
      if (refId || cardPan) {
        infoEl.classList.remove('hidden');
        var html = '';
        if (refId) {
          html += '<div class="info-row"><span class="info-label">Ø´Ù…Ø§Ø±Ù‡ ØªØ±Ø§Ú©Ù†Ø´</span><span class="info-value">' + refId + '</span></div>';
        }
        if (cardPan) {
          html += '<div class="info-row"><span class="info-label">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª</span><span class="info-value">' + cardPan + '</span></div>';
        }
        infoEl.innerHTML = html;
      }

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
      var btnsEl = document.getElementById('result-buttons');
      if (success) {
        btnsEl.innerHTML = '<button class="btn btn-primary" onclick="closeAndReturn()">ğŸŒ± Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</button>';
      } else {
        btnsEl.innerHTML = '<button class="btn btn-retry" onclick="closeAndReturn()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</button>';
      }
    }

    function closeAndReturn() {
      // Ø³Ø¹ÛŒ Ú©Ù† ØªØ¨/Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ùˆ Ø¨Ø¨Ù†Ø¯ (Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø±ÙˆÙ†â€ŒØ¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Capacitor)
      try { window.close(); } catch(e) {}
      // Ø¨Ø¹Ø¶ÛŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Capacitor Ù…Ù…Ú©Ù†Ù‡ plugin API Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯
      try {
        if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Browser &&
            typeof window.Capacitor.Plugins.Browser.close === 'function') {
          window.Capacitor.Plugins.Browser.close();
        }
      } catch(e) {}
      // Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ØŒ Û¶Û°Û°ms Ø¨Ø¹Ø¯ Ø¨Ù‡ Ø±ÛŒØ´Ù‡ Ù‡Ø¯Ø§ÛŒØª Ú©Ù† (Ù…Ù…Ú©Ù†Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨ÛŒØ±ÙˆÙ† Ø¢ÛŒØ¯)
      setTimeout(function() {
        window.location.href = '/';
      }, 600);
    }

    // Ø´Ø±ÙˆØ¹ ÙˆØ±ÛŒÙØ§ÛŒ
    function verifyPayment() {
      if (!authority) {
        showResult(false, 'Ø®Ø·Ø§', 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.', null, null);
        return;
      }

      if (status !== 'OK') {
        // Ù„ØºÙˆ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
        fetch(API_URL + '/payment/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ authority: authority, status: status })
        }).catch(function() {});

        showResult(false, 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù„ØºÙˆ Ø´Ø¯', 'Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙˆØ³Ø· Ø´Ù…Ø§ Ù„ØºÙˆ Ø´Ø¯ ÛŒØ§ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.', null, null);
        return;
      }

      // ÙˆØ±ÛŒÙØ§ÛŒ Ø¨Ø§ Ø¨Ú©Ù†Ø¯
      fetch(API_URL + '/payment/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ authority: authority, status: status })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.success) {
          var typeText = data.payment_type === 'subscription' ? 'Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯' : 'Ù¾Ú©ÛŒØ¬ ØªØ´Ø®ÛŒØµ Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯';
          showResult(
            true,
            'ğŸ‰ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚!',
            'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ Ùˆ ' + typeText + '.\nØ§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯.',
            data.ref_id || null,
            data.card_pan || null
          );
        } else {
          showResult(
            false,
            'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚',
            data.message || 'Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ú©Ø³Ø± Ù…Ø¨Ù„ØºØŒ Ø¸Ø±Ù Û·Û² Ø³Ø§Ø¹Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ØªØ§Ù† Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.',
            null,
            null
          );
        }
      })
      .catch(function(err) {
        console.error('Verify error:', err);
        showResult(
          false,
          'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ',
          'Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.',
          null,
          null
        );
      });
    }

    // Ø§Ø¬Ø±Ø§ÛŒ ÙˆØ±ÛŒÙØ§ÛŒ
    verifyPayment();
  </script>
</body>
</html>
